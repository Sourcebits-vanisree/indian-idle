
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Vote</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link href="css/stylesheet.css?v=2.4" rel="stylesheet" type="text/css" media="all">
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
</head>
<body>
  <div class="container">
   <div class="row" >
    <div class="backBtn"><a href="index.html"><img src="images/back.png"></a></div>
    <div class="col-sm-12 col-xs-12 text-center" id="headText"></div>
    <div class="col-sm-12 col-xs-12 text-center" id="contestants"></div>
    <div class="col-sm-12 col-xs-12 text-center" id="availableVotes"></div>
    <div class="col-sm-12 col-xs-12 text-center" id="votesClose"></div>
  </div>
</div>  
<!-- Vote to contestants popup -->
<div class="modal" id="vote-to-contestant">
  <div class="modal-dialog" style="top: 28%;">
    <div class="modal-content modal-transparent">
      <div class="modal-header" style="border:none;">
        <!-- <button type="button" id="closeBackBtn" class="close" data-dismiss="modal">&times;</button> -->
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-sm-12 col-xs-12 text-center voteContestantImg"></div>
        </div>
        <div class="row text-center" style="padding:0px 30px;font-size: 22px;">
         आपणास खात्री आहे
<br/>की आपण या स्पर्धकाला<br/>
वोट  करू इच्छिता?
        </div>
      </div>
      <div class="modal-footer text-center" style="border:none;">
          <span id="callVoteBtn"> </span>
          <button type="button" class="btn btn-default" data-dismiss="modal">&#10006;</button>
        </div>
    </div>
  </div>
</div>  

<!-- Votes not available message  -->
<div class="modal fade" id="votesNotAvailable" role="dialog">
  <div class="modal-dialog" style="top: 28%;">
    <div class="modal-content">
      <div class="modal-header" style="border-bottom:none;">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <p>Votes not available</p>
      </div>
    </div>
  </div>
</div>
<script src="js/config.js"></script>
<script src="config/data.js"></script>
<script>
  var json_data = '';
  var voteText = '';
  var voteEpisodeId = '';
  var maxVotes;

  // $.getJSON( "config/data.json")
  // .done(function( json ) {
   /* Vote close */
   var localDT = new Date();
   var localDT = new Date();
   var localTime = localDT.getTime();
   var serverTime = localStorage.getItem("serverTime");
   var serverTime = parseInt(serverTime);
   var serverDT = new Date(serverTime);
   var startDTObj = new Date(json.vote.startTime.replace(/-/g, "/"));
   var startDT = startDTObj.getTime();
   var endDTObj= new Date(json.vote.endTime.replace(/-/g, "/"));
   var endDT = endDTObj.getTime();
   var startTime = startDT;
   var endTime = endDT;
   var startDT = new Date(startTime);
   var endDT = new Date(endTime);
   var endDate = endDT.getFullYear()+'/'+ endDT.getMonth() +'/'+endDT.getDate();
   var startDate = startDT.getFullYear()+'/'+ startDT.getMonth() +'/'+startDT.getDate();
   var localDate = localDT.getFullYear()+'/'+localDT.getMonth()+'/'+localDT.getDate();
   var serverDate = serverDT.getFullYear()+'/'+serverDT.getMonth()+'/'+serverDT.getDate();
   console.log("localdate"+localDT);console.log("serverDT"+serverDT);console.log("startDT"+startDT);console.log("endDT"+endDT);
   var showTimeStatus = false;
   
   // if (serverDate == localDate && localDate == startDate) {
    if (serverDate == localDate && localDate >= startDate && localDate <= endDate ){
    var timeDiff = (serverTime - localTime)/1000;/* in secs */
    var timeDiffAbs =Math.abs(timeDiff);
    var timeDiffSign = Math.sign(timeDiff);
    if(timeDiffSign == 1){
      var  correctLocalTime = localTime + timeDiffAbs;
    }else{
      var  correctLocalTime = localTime - timeDiffAbs;
    }
    if (startTime <= (correctLocalTime) && endTime >= (correctLocalTime)) {
      initializeClock('clockdiv', endTime,serverTime);
      showTimeStatus = true;
    }else{
      if(endTime >= (localTime+timeDiff)){
        window.location.href= 'beforeWaitingPage.html';
      }else{
        window.location.href= 'afterWaitingPage.html';
      }
      
    }

  }
  else{
    if(startTime > serverTime){
     window.location.href= 'beforeWaitingPage.html';
   }else{
      // console.log('afterWaitingPage2');
      window.location.href= 'afterWaitingPage.html';
    }
  }
  
  // add date validation to open vote page
  // var showTimeStatus = true;
  if(showTimeStatus === true){
    json_data = json;
    maxVotes = json_data.vote.maxVotes;
    $("body").css("background", "url("+ json.vote.backgroubdImage +")");
    $('#headText').html(json.vote.headText);
    $('#headText').css({"color":json.vote.color,"font-size":json.vote.font});
    $('#contestants').css({"color":json.vote.color,"font-size":json.vote.font});
    for (var i=0; i<json.vote.contestants.length; i++){
      var cid = "cid"+json.vote.contestants[i].cid;
      var contestantVotes = '';
      if(sessionStorage.getItem(cid) !== "0" && sessionStorage.getItem(cid) !== null){
        contestantVotes = "<span class='contestant-votes'>"+ sessionStorage.getItem(cid) +"</span>";
      }

      $('#contestants').append("<div class='col-sm-4 col-xs-6 text-center contestants-img'><span data-cid='"+ json.vote.contestants[i].cid +"'>"+ contestantVotes +"</span><img src="+ json.vote.contestants[i].image +"></div>");
    }
    voteText = json.vote.voteText;
    voteEpisodeId = json.vote.voteEpisodeId;
  }
  $(document).ready(function(){ 
    NumOfVotesLeft(false);
    //Voting confirmation popup
    $(".container").on("click",'.contestants-img',function(){ 
      // $('.backBtn').hide();
      var totalUserVotes = localStorage.getItem("totalUserVotes");
      if(maxVotes > parseInt(totalUserVotes)){
        var imgUrl = $(this).children('img').attr('src');
        // var name = $(this).find('.contenstantName').text();
        var cid = $(this).children().attr('data-cid');
        $('#callVoteBtn').html('');
        $('.voteContestantImg').html('');
        $('.voteContestantImg').append("<img src='"+ imgUrl +"'>");
        $('#callVoteBtn').append("<button type='button' class='btn btn-default' onclick='voteApiCall("+cid+")'>&#10004;</button>");
        $('#vote-to-contestant').modal('show'); 
      }else{
        $('#votesNotAvailable').modal('show');
      }
    });
    
    $("#closeBackBtn").on("click",function(){
      // $('.backBtn').show();
    })
    // $('body').on("click",function(){
    //   if($('body').find('.modal-open') == false){
    //     $('.backBtn').show();
    //   }
    // });
  });

  function voteApiCall(contestantId)
  {
   // $('.backBtn').show();
    //Api call 
    var contestantData = {"userProfileId" : parseInt(localStorage.getItem("userId")) ,
    "contestantId" : contestantId,
    "mobileTime" : Date.now(),
    "voteEpisodeId" : voteEpisodeId};

    $.ajax({
     crossDomain: true,
     type: "POST",
     url: api_url.voteForContestant,
     data: JSON.stringify(contestantData),
     contentType: 'application/json; charset=utf-8',
     dataType: 'json',
     async: false,
     success: function (data) {
       var cid = "cid"+contestantId;
       var votes = 0;
       $('#vote-to-contestant').modal('hide');
       if(sessionStorage.getItem(cid)){
        votes = sessionStorage.getItem(cid);
      }
      sessionStorage.setItem(cid, (parseInt(votes, 10) + 1));
      contestantVotes = "<span class='contestant-votes'>"+ (parseInt(votes, 10) + 1) +"</span>";
      $('span[data-cid="'+ contestantId +'"]').html(contestantVotes);
      NumOfVotesLeft(true);
    },
    error: function (jqXHR, status) {
       // error handler
       console.log(jqXHR);
       console.log('fail' + status.code);
     }
   });
    $('#vote-to-contestant').modal('hide'); 
  }

  /* Number of votes available */
  function NumOfVotesLeft(status){
    var totalUserVotes = localStorage.getItem("totalUserVotes");
    if(status === true){
      var totalUserVotes = (parseInt(totalUserVotes, 10) + 1);
      localStorage.setItem("totalUserVotes",totalUserVotes);
    }

    if(maxVotes >= totalUserVotes){
      var availableVotes = maxVotes - totalUserVotes;
      $("#availableVotes").html('');
      $("#availableVotes").html("<span class='availableVotes'>Left "+ availableVotes +" Votes</span>");
    }
  }
    //time counter
    function getTimeRemaining(endtime,starttime) {
     var t = Date.parse(endtime) - Date.parse(new Date(starttime));
     var seconds = Math.floor((t / 1000) % 60);
     var minutes = Math.floor((t / 1000 / 60) % 60);
     var hours = Math.floor((t / (1000 * 60 * 60)) % 24);
     return {
      'total': t,
      'hours': hours,
      'minutes': minutes,
      'seconds': seconds
    };
  }

  function initializeClock(id, endtime,starttime) {

    function updateClock() {
      endtime = new Date(endtime);
      endtime.setSeconds(endtime.getSeconds() - 1);
      var t = getTimeRemaining(endtime,starttime);
      var counterDisplay = ('0' + t.hours).slice(-2) +':'+ ('0' + t.minutes).slice(-2) +':'+ ('0' + t.seconds).slice(-2)
      $("#votesClose").html('<span class="votesClose">Vote closes in '+ counterDisplay +'</span>');

      if (t.total <= 0) {
        window.location.href= 'afterWaitingPage.html';
      }
    }

    updateClock();
    var timeinterval = setInterval(updateClock, 1000);
  }
  $(document.body).click( function() {
    if($('.modal-open').length){
      // $('.backBtn').hide();
    }else{
      // $('.backBtn').show();
    }
  });
</script>
</body>
</html>
