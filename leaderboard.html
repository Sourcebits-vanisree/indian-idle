<!DOCTYPE html>
<html lang="en">
<head>
	<title>LEADERBOARD</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="bootstrap4/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
	<script src="js/jquery.min.js"></script>
	<script src="bootstrap4/js/bootstrap.min.js"></script>
</head>
<body>

	<div class="container p-0">
		<div class="row pt-4 mb-4 no-gutters">
			<div class="backBtn"><a href="index.html"><img src="images/back.png"></a></div>
			<div class="col-2"></div>
			<div class="col-3" >
				<div class="float-right"><img id="profilePicUrl" src="images/default-male-photo.png" width="100px" height="100px" class="rounded-circle" onerror="imgError(this);"></div>
			</div>
			<div class="col-7 text-center ">
				<div class="d-inline-block">
					<div  class="name text-white verticle-center"><span  id="profileName"></span><br><span class="font-color" id="profilePoints" >0</span><span class="font-color"> points</span></div>
				</div>
			</div>
		</div>  
		<div class="row no-gutters">
			<div class="col-12 text-center text-white "><h4 class="display-5">LEADERBOARD</h4></div>
		</div>
		<div class="scroll-toprankers no-gutters" id="leaders">
		</div>   
	</div>
	<script src="js/config.js"></script>
	<script type="text/javascript">
	var pagination =1;
    var lastPage =0;
	$.getJSON( "config/data.json" )
	.done(function( json ) {
		$("body").css("background", "url("+ json.vote.backgroundImage +")");
	})
	.fail(function( jqxhr, textStatus, error ) {
		var err = textStatus + ", " + error;
		console.log( "Request Failed: " + err );
	});
	
	$(document).ready(function(){
		var name = localStorage.getItem('name');
		var userid = localStorage.getItem('userId');
		var getProfileDetails = api_url.get_Profile+userid+'.json?'+$.now();
		$.getJSON(getProfileDetails,function(json){
			if(json.name.length>=24){
				$(".right1 .name").css("line-height", "17.5px");
			}
			$('#profilePicUrl').attr('src',json.profilePicUrl);
			$('#profileName').text(json.name);
			$('#profileRank').text(numberWithCommas(json.rank));
			$('#profilePoints').text(numberWithCommas(json.points));
		});
		var replaceString = "leader"+pagination+".json";
		var currentUrl = api_url.top_Ranks.replace("leader.json",replaceString);
		currentUrl=currentUrl+"?"+$.now();
		topRanks(currentUrl);
});
function topRanks(toprankers_url){
	$.getJSON(toprankers_url,function(json){
		//debugger;
		
		var jsonCount = Object.keys(json).length;
		if (jsonCount < 50 && jsonCount > 0) {
			lastPage = pagination;
		};
		$('.load-more').remove();
//alert(ranks_per_page);
var itemC=(pagination-1)*50;
console.log(json);
$.each(json, function(i, result) {
result=$.parseJSON(result[0]);

// result=result[0];
if(result.profilePicUrl==undefined || result.profilePicUrl==""){
	result.profilePicUrl="images/default-male-photo.png";
}
itemC++;
var length_ranks=(4-result.totalRewardPoints.length);
result.socialUserNameTemp=result.socialUserName.substr(0,(16+length_ranks));
if(result.socialUserName.length!=result.socialUserNameTemp.length){
	result.socialUserName=result.socialUserNameTemp+"...";
}else{
	result.socialUserName=result.socialUserNameTemp;
}
var output='<div class="row no-gutters pt-2"><div class="col-2 text-center position-relative mt-3"><pre class="text-white">'+itemC+'</pre></div><div class="col-2 leader-info"><img src="'+result.profilePicUrl+'" class="leader-image" width="40px" height="40px" onerror="imgError(this);"></div><div class="col-5 position-relative mt-3"><pre class="text-white">'+result.socialUserName+'</pre></div><div class="col-3 position-relative mt-3"><pre class="font-color">'+result.totalRewardPoints+' pts</pre></div></div>';
// var output='<div class="items"><div class="leader-info"><span class="rank"><span>'+itemC+' </span><img src="'+result.profilePicUrl+'" class="leader-image" onerror="imgError(this);" width><span>'+result.socialUserName+' </span><span>'+result.totalRewardPoints+' pts</span></span></div></div>';
$('#leaders').append(output);
});
if (lastPage != pagination) {
	$('#leaders:last-child').append("<div class='row border-bottom load-more no-gutters'><div class='col-12 pb-4 pt-1 text-center'><span onclick='nextRanks()'>Load More</span></div></div>");
};
}).fail(function(jqXHR) {
	if (jqXHR.status == 404) {
		lastPage = pagination;
		nextRanks();
	} else {
		lastPage = pagination;
		nextRanks();
	}
});
}
function nextRanks(){
	if (lastPage != pagination) {
		pagination++;
		var replaceString = "leader"+pagination+".json";
		var nextUrl = api_url.top_Ranks.replace("leader.json",replaceString);
		nextUrl=nextUrl+"?"+$.now();
		topRanks(nextUrl);
	};
}
function imgError(image) {
	image.onerror = "";
	image.src = "images/default-male-photo.png";
	return true;
}
function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
</script>
</body>
</html>